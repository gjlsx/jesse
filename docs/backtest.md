# 回测

假设你已经[创建](strategies.md)了第一个策略并[导入](import-candles.md)了策略的历史蜡烛图数据，现在是时候实际回测它了：

![回测界面](https://api1.jesse.trade/storage/images/docs/backtest-dark-1.jpg)

选择路由后，按下"开始"按钮。以下是结果：

![回测结果](https://api1.jesse.trade/storage/images/docs/backtest-results.jpg)

## 回测流程

### 1. 准备工作
在开始回测之前，确保你已经：
- 创建了策略文件
- 导入了相应的历史数据
- 配置了正确的路由

### 2. 设置回测参数
在回测表单中，你可以设置：
- **开始日期**: 回测的起始时间
- **结束日期**: 回测的结束时间
- **路由**: 选择要测试的策略和交易对
- **资金**: 初始资金量
- **手续费**: 交易手续费率

### 3. 回测选项
- **导出图表**: 生成传统图表
- **导出 TradingView**: 生成 TradingView Pine 脚本
- **导出 CSV**: 导出交易记录到 CSV 文件
- **导出 JSON**: 导出交易记录到 JSON 文件

## 图表分析

除了在指标部分看到的图表外，还有两个"传统图表"，你可以通过在回测选项部分切换"导出图表"复选框来启用。这两个图表将来会移到指标部分。

回测完成后，你可以通过按"传统图表"按钮下载图表。以下是图表示例：

![传统图表示例](https://api1.jesse.trade/storage/images/docs/legacy-charts-example.jpg)

## TradingView 集成

这个功能对那些使用 [TradingView](https://www.tradingview.com/) 进行图表分析的人很有用。要启用它，你需要在回测表单中勾选"导出 TradingView"选项。

在过程结束时，你将能够下载一个包含 Pine 脚本内容的 `.txt` 文件。然后打开文件，复制其内容，并将其粘贴到 [TradingView](https://www.tradingview.com/) 的 Pine 编辑器中。现在点击"添加到图表"，你将看到策略的入场和出场点。

> **警告**：确保在与回测模拟执行相同的时间框架中查看图表。另外，由于 TradingView 的限制，只显示最后约30笔交易。

> **警告**：TradingView 回测指标中的数字通常与你在 Jesse 中看到的不同。这是完全正常的，考虑到 TradingView 主要不是回测软件，其结果不应该被依赖。然而，Jesse 是专业的回测软件。

## 数据导出

### CSV 导出

Jesse 可以将完成的交易输出到 CSV 文件。你可以用 Excel、Google Sheets 或任何你喜欢的工具打开这个 CSV 文件来分析完成的交易、绘制进一步的图表等。

要使用它，在回测表单中勾选"导出 CSV"选项。回测完成后，Jesse 会打印 CSV 文件的路径，你可以下载它。

#### CSV 文件包含的字段：
- **symbol**: 交易对
- **type**: 订单类型（市价单/限价单）
- **side**: 买入/卖出
- **qty**: 数量
- **price**: 价格
- **flag**: 订单标记（开仓/平仓/止损/止盈）
- **opened_at**: 开仓时间
- **closed_at**: 平仓时间
- **duration**: 持仓时长
- **pnl**: 盈亏
- **pnl_percentage**: 盈亏百分比
- **fee**: 手续费

### JSON 导出

Jesse 可以将完成的交易输出到 JSON 格式的文件。JSON 格式是一种流行的 JavaScript 格式，通常用于在网络上创建 API。

在回测表单中勾选"导出 JSON"选项来使用它。回测完成后，Jesse 会打印 JSON 文件的路径。

#### JSON 文件结构：
```json
{
  "trades": [
    {
      "id": 1,
      "symbol": "BTCUSDT",
      "side": "buy",
      "type": "MARKET",
      "qty": 0.1,
      "price": 50000,
      "opened_at": "2023-01-01T00:00:00",
      "closed_at": "2023-01-01T01:00:00",
      "pnl": 100,
      "pnl_percentage": 2.0,
      "fee": 10
    }
  ],
  "metrics": {
    "total_trades": 100,
    "winning_trades": 60,
    "losing_trades": 40,
    "win_rate": 0.6,
    "total_pnl": 1000,
    "max_drawdown": -200
  }
}
```

## 交易记录可视化分析

有一个由社区成员制作的工具叫做"Jesse trades info"。它帮助解析 JSON 回测文件并使用表格和图表以方便的方式显示它们。

你可以在其 [GitHub 仓库页面](https://github.com/nicolay-zlobin/jesse-trades-info) 找到截图和视频。

## 回测指标解读

### 基础指标
- **总交易数**: 完成的交易总数
- **获利交易数**: 盈利的交易数量
- **亏损交易数**: 亏损的交易数量
- **胜率**: 获利交易占总交易的百分比

### 收益指标
- **总盈亏**: 总的盈亏金额
- **总回报率**: 总回报百分比
- **年化回报率**: 按年计算的回报率
- **夏普比率**: 风险调整后的回报率

### 风险指标
- **最大回撤**: 从峰值到谷值的最大损失
- **最大回撤持续时间**: 回撤持续的最长时间
- **波动率**: 收益的标准差
- **VAR (风险价值)**: 在给定置信水平下的潜在损失

### 交易质量指标
- **平均获利**: 单笔获利交易的平均金额
- **平均亏损**: 单笔亏损交易的平均金额
- **盈亏比**: 平均获利与平均亏损的比率
- **最大连续获利**: 连续获利的最大次数
- **最大连续亏损**: 连续亏损的最大次数

## 回测最佳实践

### 1. 数据质量
- 使用高质量的历史数据
- 确保数据完整性，没有缺失
- 使用足够长的时间段进行测试

### 2. 现实性考虑
- 包含合理的手续费
- 考虑滑点影响
- 设置现实的订单执行延迟

### 3. 样本外测试
- 保留一部分数据用于样本外测试
- 不要在全部历史数据上优化参数
- 使用前向分析验证策略

### 4. 多市场测试
- 在不同的市场条件下测试
- 测试多个交易对
- 考虑不同的时间框架

### 5. 风险管理
- 评估最大回撤是否可接受
- 分析连续亏损的影响
- 确保资金管理规则的有效性

## 常见问题

### 1. 回测结果与实盘差异
- 检查手续费设置
- 考虑滑点和延迟
- 验证数据质量

### 2. 过度拟合
- 避免过度优化参数
- 使用样本外测试
- 保持策略简单

### 3. 数据偏差
- 使用多个数据源
- 注意幸存者偏差
- 考虑前瞻偏差

### 4. 性能问题
- 优化策略代码
- 减少不必要的计算
- 使用合适的数据量

## 下一步

成功完成回测后，你可以：

1. **分析结果**: 仔细研究回测指标和交易记录
2. **优化策略**: 基于回测结果调整策略参数
3. **样本外测试**: 在新数据上验证策略
4. **实盘测试**: 在模拟环境中测试策略
5. **部署实盘**: 在真实市场中运行策略（需要实盘交易插件）

记住，回测只是策略开发过程的一部分。成功的回测并不保证未来的盈利，但它是评估策略潜力的重要工具。
